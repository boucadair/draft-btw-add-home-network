<?xml version="1.0" encoding="US-ASCII"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!-- One method to get references from the online citation libraries.
     There has to be one entity for each item to be referenced. 
     An alternate method (rfc include) is described in the references. -->
]>
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<!-- used by XSLT processors -->
<!-- For a complete list and description of processing instructions (PIs), 
     please see http://xml.resource.org/authoring/README.html. -->
<!-- Below are generally applicable Processing Instructions (PIs) that most I-Ds might want to use.
     (Here they are set differently than their defaults in xml2rfc v1.32) -->
<?rfc strict="yes" ?>
<!-- give errors regarding ID-nits and DTD validation -->
<!-- control the table of contents (ToC) -->
<?rfc toc="yes"?>
<!-- generate a ToC -->
<?rfc tocdepth="4"?>
<!-- the number of levels of subsections in ToC. default: 3 -->
<!-- control references -->
<?rfc symrefs="yes"?>
<!-- use symbolic references tags, i.e, [RFC2119] instead of [1] -->
<?rfc sortrefs="yes" ?>
<!-- sort the reference entries alphabetically -->
<!-- control vertical white space 
     (using these PIs as follows is recommended by the RFC Editor) -->
<?rfc compact="yes" ?>
<!-- do not start each main section on a new page -->
<?rfc subcompact="no" ?>
<!-- keep one blank line between list items -->
<!-- end of list of popular I-D processing instructions -->
<rfc category="std" docName="draft-btw-add-home-latest" ipr="trust200902">
  <front>
    <title abbrev="Encrypted DNS in Home Networks">Encrypted DNS Discovery and
    Deployment Considerations for Home Networks</title>

    <author fullname="Mohamed Boucadair" initials="M." surname="Boucadair">
      <organization>Orange</organization>

      <address>
        <postal>
          <street></street>

          <city>Rennes</city>

          <code>35000</code>

          <country>France</country>
        </postal>

        <email>mohamed.boucadair@orange.com</email>
      </address>
    </author>

    <author fullname="Tirumaleswar Reddy" initials="T." surname="Reddy">
      <organization abbrev="McAfee">McAfee, Inc.</organization>

      <address>
        <postal>
          <street>Embassy Golf Link Business Park</street>

          <city>Bangalore</city>

          <region>Karnataka</region>

          <code>560071</code>

          <country>India</country>
        </postal>

        <email>TirumaleswarReddy_Konda@McAfee.com</email>
      </address>
    </author>

    <author fullname="Dan Wing" initials="D." surname="Wing">
      <organization abbrev="Citrix">Citrix Systems, Inc.</organization>

      <address>
        <postal>
          <street></street>

          <country>USA</country>
        </postal>

        <email>dwing-ietf@fuggles.com</email>
      </address>
    </author>

    <author fullname="Neil Cook" initials="N." surname="Cook">
      <organization>Open-Xchange</organization>

      <address>
        <postal>
          <street></street>

          <country>UK</country>
        </postal>

        <email>neil.cook@noware.co.uk</email>
      </address>
    </author>

    <date />

    <workgroup>ADD</workgroup>

    <abstract>
      <t>The document specifies new DHCP and Router Advertisement Options to
      discover encrypted DNS servers (e.g., DoH, DoT, DoQ). Particularly, it
      allows to learn an Authentication Domain Name together with a list of IP
      addresses and optionally a port number to reach such encrypted DNS
      servers.</t>

      <t>This document focuses on encrypted DNS deployment within home
      networks. </t>
    </abstract>
  </front>

  <middle>
    <section anchor="intro" title="Introduction">
      <t>Internet Service Providers (ISPs) traditionally provide DNS resolvers
      to their customers. Typically, ISPs deploy the following mechanisms to
      advertise a list of DNS Recursive DNS server(s) to their customers: </t>

      <t><list style="symbols">
          <t>Protocol Configuration Options in cellular networks <xref
          target="TS.24008"></xref>.</t>

          <t>DHCP <xref target="RFC2132"></xref> (Domain Name Server Option)
          or DHCPv6 <xref target="RFC8415"></xref><xref
          target="RFC3646"></xref> (OPTION_DNS_SERVERS).</t>

          <t>IPv6 Router Advertisement <xref target="RFC4861"></xref><xref
          target="RFC8106"></xref> (Type 25 (Recursive DNS Server
          Option)).</t>
        </list></t>

      <t>The communication between a customer's device (possibly via Customer
      Premises Equipment (CPE)) and an ISP-supplied DNS resolver takes place
      by using cleartext DNS messages (Do53) <xref
      target="I-D.ietf-dnsop-terminology-ter"></xref>. Some examples are
      depicted in <xref target="do53"></xref>. In the case of cellular
      networks, the cellular network will provide connectivity directly to a
      host (e.g., smartphone, tablet) or via a CPE. Do53 mechanisms used
      within the Local Area Network (LAN) are similar in both fixed and
      cellular CPE-based broadband service offerings.</t>

      <t><figure align="center" anchor="do53"
          title="Sample Legacy Deployments">
          <artwork align="center"><![CDATA[(a) Fixed Networks
           ,--,--,--.             ,--,--,--.
        ,-'   +--+  `-.       ,-'   ISP    `-. 
       ( LAN  |H |    CPE----(                 )
        `-.   +--+   ,-'       `-.          ,-' 
           `--'|-'--'             `--'--'--'    
               |                     |
               |<=======Do53========>| 

(b) Cellular Networks
                |<===========Do53=========>| 
           ,--,-|,--.                      |
        ,-'   +--+   `-.               ,--,--,--.    
       ( LAN  |H |     CPE------------+          \
        `-.   +--+   ,-'            ,'   ISP     `-. 
           `--'--'--'              (                )
                              +-----+-.          ,-'
              +--+            |        `--'--'--'  
              |H +------------+
              +--+
Legend:
 * H: refers to a host.
]]></artwork>
        </figure></t>

      <t>This document focuses on the support of encrypted DNS such as
      DNS-over-HTTPS (DoH) <xref target="RFC8484"></xref>, DNS-over-TLS (DoT)
      <xref target="RFC7858"></xref>, or DNS-over-QUIC (DoQ) <xref
      target="I-D.ietf-dprive-dnsoquic"></xref> in local networks. In
      particular, the document describes how a local encrypted DNS server can
      be discovered and used by connected hosts by means of DHCP, DHCPv6, and
      RA options (<xref target="RI"></xref>). These options are designed to
      convey the following information: the DNS Authentication Domain Name
      (ADN) <xref target="RFC8310"></xref>, a list of IP addresses, and
      optionally a port number.</t>

      <t>Some ISPs rely upon external resolvers (e.g., outsourced service or
      public resolvers); these ISPs provide their customers with the IP
      addresses of these resolvers. These addresses are typically configured
      on CPEs using the same mechanisms listed above. Likewise, users can
      modify the default DNS configuration of their CPEs (e.g., supplied by
      their ISP) to configure their favorite DNS servers. This document
      permits such deployments.</t>

      <t>Both managed and unmanaged CPEs are discussed in the document (<xref
      target="depl"></xref>). Also, considerations related to hosting a DNS
      forwarder in the CPE are described (<xref
      target="forwarder"></xref>).</t>

      <t>Hosts and/or CPEs may be connected to multiple networks; each
      providing their own DNS configuration using the discovery mechanisms
      specified in this document. Nevertheless, it is out of the scope of this
      specification to discuss DNS selection of multi-interface devices. The
      reader may refer to <xref target="RFC6731"></xref> for a discussion of
      issues and an example of DNS server selection for multi-interfaced
      devices.</t>
    </section>

    <section anchor="notation" title="Terminology">
      <t>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
      "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED", "MAY", and
      "OPTIONAL" in this document are to be interpreted as described in BCP 14
      <xref target="RFC2119"></xref><xref target="RFC8174"></xref> when, and
      only when, they appear in all capitals, as shown here.</t>

      <t>This document makes use of the terms defined in <xref
      target="RFC8499"></xref> and <xref
      target="I-D.ietf-dnsop-terminology-ter"></xref>.</t>

      <t>Do53 refers to unencrypted DNS.</t>

      <t>'Encrypted DNS' refers to a scheme where DNS exchanges are
      transported over an encrypted channel. Examples of encrypted DNS are
      DNS-over-TLS (DoT) <xref target="RFC7858"></xref>, DNS-over-HTTPS (DoH)
      <xref target="RFC8484"></xref>, or DNS-over-QUIC (DoQ) <xref
      target="I-D.ietf-dprive-dnsoquic"></xref>.</t>
    </section>

    <section anchor="depl" title="Sample Target Deployment Scenarios">
      <t></t>

      <section anchor="mcpe" title="Managed CPEs">
        <t>ISPs have developed an expertise in managing service-specific
        configuration information (e.g., CPE WAN Management Protocol <xref
        target="TR-069"></xref>). For example, these tools may be used to
        provision the DNS server's ADN to managed CPEs if an encrypted DNS is
        supported by a local network similar to what is depicted in <xref
        target="wan"></xref>.</t>

        <t>For example, DoH-capable (or DoT) clients establish the DoH (or
        DoT) session with the discovered DoH (or DoT) server.</t>

        <t>The DNS client discovers whether the DNS server in the local
        network supports DoH/DoT/DoQ by using a dedicated field in the
        discovery message: Encrypted DNS Types (<xref
        target="RI"></xref>).</t>

        <t><figure align="center" anchor="wan"
            title="Encrypted DNS in the WAN">
            <artwork align="center"><![CDATA[(a) Fixed Networks

           ,--,--,--.             ,--,--,--.
        ,-'   +--+  `-.       ,-'   ISP    `-. 
       ( LAN  |H |    CPE----(    DNS Server  )
        `-.   +--+   ,-'       `-.         ,-' 
           `--'|-'--'             `--'--'--'    
               |                     |
               |<===Encrypted DNS===>| 

(b) Cellular Networks    
                                                                      
                |<=====Encrypted DNS======>| 
           ,--,-|,--.                      |
        ,-'   +--+   `-.               ,--,--,--.    
       ( LAN  |H |     CPE------------+          \
        `-.   +--+   ,-'            ,'   ISP     `-. 
           `--'--'--'              (    DNS Server  )
                              +-----+-.          ,-'
               +--+           |        `--'--'--'  
               |H +-----------+
               +--+]]></artwork>
          </figure></t>

        <t><xref target="wan"></xref> shows the scenario where the CPE relays
        the list of encrypted DNS servers it learns for the network by using
        mechanisms like DHCP or a specific Router Advertisement message. In
        such context, direct encrypted DNS sessions will be established
        between a host serviced by a CPE and an ISP-supplied encrypted DNS
        server (see the example depicted in <xref target="direct"></xref> for
        a DoH/DoT-capable host).</t>

        <t><figure align="center" anchor="direct"
            title="Direct Encrypted DNS Sessions">
            <artwork><![CDATA[
                      ,--,--,--.             ,--,--,--.
                   ,-'          `-.       ,-'   ISP    `-.
           Host---(      LAN      CPE----(    DNS Server  )
             |     `-.          ,-'       `-.          ,-'
             |        `--'--'--'             `--'--'--'
             |                                   | 
             |<=========Encrypted DNS===========>|
]]></artwork>
          </figure></t>

        <t><xref target="proxied"></xref> shows a deployment where the CPE
        embeds a caching DNS forwarder. The CPE advertises itself as the
        default DNS server to the hosts it serves. The CPE relies upon DHCP or
        RA to advertise itself to internal hosts as the default DoT/DoH/Do53
        server. When receiving a DNS request it cannot handle locally, the CPE
        forwards the request to an upstream DoH/DoT/Do53 resolver. Such
        deployment is required for IPv4 service continuity purposes (e.g.,
        <xref target="I-D.ietf-v6ops-rfc7084-bis"></xref>) or for supporting
        advanced services within the home (e.g., malware filtering, parental
        control, Manufacturer Usage Description (MUD) <xref
        target="RFC8520"></xref> to only allow intended communications to and
        from an IoT device). When the CPE behaves as a DNS forwarder, DNS
        communications can be decomposed into two legs:<list style="symbols">
            <t>The leg between an internal host and the CPE.</t>

            <t>The leg between the CPE and an upstream DNS resolver.</t>
          </list></t>

        <t>An ISP that offers encrypted DNS to its customers may enable
        encrypted DNS in both legs as shown in <xref target="proxied"></xref>.
        Additional considerations related to this deployment are discussed in
        <xref target="forwarder"></xref>.</t>

        <t><figure align="center" anchor="proxied"
            title="Proxied Encrypted DNS Sessions">
            <artwork><![CDATA[
                      ,--,--,--.             ,--,--,--.
                   ,-'          `-.       ,-'   ISP    `-.
           Host---(      LAN      CPE----(    DNS Server  )
             |     `-.          ,-'|      `-.          ,-'
             |        `--'--'--'   |         `--'--'--'
             |                     |             | 
             |<=====Encrypted=====>|<=Encrypted=>| 
                       DNS                DNS
]]></artwork>
          </figure></t>

        <t></t>
      </section>

      <section anchor="ucpe" title="Unmanaged CPEs">
        <t>Customers may decide to deploy unmanaged CPEs (assuming the CPE is
        compliant with the network access technical specification that is
        usually published by ISPs). Upon attachment to the network, an
        unmanaged CPE receives from the network its service configuration
        (including the DNS information) by means of, e.g., DHCP. That DNS
        information is shared within the LAN following the same mechanisms as
        those discussed in <xref target="mcpe"></xref>. A host can thus, for
        example, establish DoH/DoT session with a DoH/DoT server similar to
        what is depicted in <xref target="direct"></xref>.</t>

        <t>Customers may also decide to deploy internal home routers (called
        hereafter, Internal CPEs) for a variety of reasons that are not
        detailed here. Absent any explicit configuration on the internal CPE
        to override the DNS configuration it receives from the ISP-supplied
        CPE, an Internal CPE relays the DNS information it receives via
        DHCP/RA from the ISP-supplied CPE to connected hosts. Encrypted DNS
        sessions can be established by a host with the DNS servers of the ISP
        (see <xref target="internal_isp"></xref>).</t>

        <t><figure align="center" anchor="internal_isp"
            title="Direct Encrypted DNS Sessions with the ISP DNS Resolver (Internal CPE)">
            <artwork align="center"><![CDATA[
          ,--,--,--.                    ,--,--,--.
       ,-'          Internal         ,-'    ISP   `-.
Host--(    Network#A   CPE----CPE---(    DNS Server   )
 |     `-.          ,-'              `-.          ,-'
 |        `--'--'--'                    `--'--'--'
 |                                          | 
 |<==============Encrypted DNS=============>|
]]></artwork>
          </figure></t>

        <t>Similar to managed CPEs, a user may modify the default DNS
        configuration of an unmanaged CPE to use his/her favorite DNS servers
        instead. Encrypted DNS sessions can be established directly between a
        host and a 3rd Party DNS server (see <xref
        target="internal_3"></xref>).</t>

        <t><figure align="center" anchor="internal_3"
            title="Direct Encrypted DNS Sessions with a Third Party DNS Resolver ">
            <artwork align="center"><![CDATA[         ,--,--,--.                  ,--,
       ,'         Internal        ,-'    '-     3rd Party
Host--(  Network#A  CPE----CPE---(   ISP   )--- DNS Server
 |     `.         ,-'             `-.    -'         |
 |       `-'--'--'                   `--'           |
 |                                                  | 
 |<=================Encrypted DNS==================>|
]]></artwork>
          </figure></t>

        <t><xref target="forwarder_u"></xref> discusses considerations related
        to hosting a forwarder in the Internal CPE.</t>
      </section>
    </section>

    <section anchor="RI" title="Encrypted DNS Discovery Options">
      <t>This section describes how a DNS client can discover a local
      encrypted DNS server(s) using DHCP (Sections <xref format="counter"
      target="DHCPv6"></xref> and <xref format="counter"
      target="DHCP"></xref>) and Neighbor Discovery protocol (<xref
      target="RA"></xref>).</t>

      <t>As reported in Section 1.7.2 of <xref target="RFC6125"></xref>:<list
          style="empty">
          <t>"few certification authorities issue server certificates based on
          IP addresses, but preliminary evidence indicates that such
          certificates are a very small percentage (less than 1%) of issued
          certificates".</t>
        </list></t>

      <t>In order to allow for PKIX-based authentication between a DNS client
      and an encrypted DNS server while accommodating the current best
      practices for issuing certificates, this document allows for configuring
      an authentication domain name to be presented as a reference identifier
      for DNS authentication purposes.</t>

      <t>To avoid adding a dependency on another server to resolve the ADN,
      the options return a list of IP addresses to locate the encryptd DNS
      server. In the various scenarios sketched in <xref
      target="depl"></xref>, encrypted DNS servers may terminate on the same
      IP address or distinct IP addresses. Terminating encrypted DNS servers
      on the same or distinct IP addresses is deployment-specific. It is
      RECOMMENDED to return both the ADN and a list of IP addresses.</t>

      <t>Note that in order to optimize the size of discovery messages when
      all servers terminate on the same IP address, a host may rely upon the
      discovery mechanisms specified in <xref target="RFC2132"></xref><xref
      target="RFC3646"></xref><xref target="RFC8106"></xref> to retrieve a
      list of IP addresses to reach their DNS servers. Nevertheless, this
      approach requires a client that supports more than one encrypted DNS to
      probe the list of IP addresses. To avoid such probing, the options
      defined in the following sections are designed to associate an IP
      address with an encrypted DNS type.</t>

      <t>Because DoT and DoQ may make use of customized port numbers instead
      of default ones, the options are also designed to return alternate port
      numbers.</t>

      <t>The DNS client establishes an encrypted DNS session with the
      discovered DNS IP address(es) and port number, and uses the mechanism
      discussed in Section 8 of <xref target="RFC8310"></xref> to authenticate
      the DNS server certificate using the authentication domain name conveyed
      in the encrypted DNS options.</t>

      <t>If the encrypted DNS is discovered by a host using both RA and DHCP,
      the rules discussed in Section 5.3.1 of <xref target="RFC8106"></xref>
      MUST be followed.</t>

      <section anchor="DHCPv6" title="DHCPv6 Encrypted DNS Options">
        <t>The DHCPv6 Encrypted DNS ADN option is used to configure an
        authentication domain name of the encrypted DNS server. The format of
        this option is shown in <xref target="ri_option"></xref>.</t>

        <t><figure anchor="ri_option" title="DHCPv6 Encrypted DNS ADN Option">
            <artwork><![CDATA[    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |    OPTION_V6_ENC_ADN          |         Option-length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Enc DNS Type |                 Unassigned                    |
   +---------------+-----------------------------------------------+
   |                                                               |
   ~                  DNS Authentication Domain Name               ~
   |                                                               |
   +---------------------------------------------------------------+
]]></artwork>
          </figure></t>

        <t>The fields of the option shown in <xref target="ri_option"></xref>
        are as follows:<?rfc subcompact="yes" ?></t>

        <t><list style="symbols">
            <t>Option-code: OPTION_V6_ENC_ADN (TBA1, see <xref
            target="iana6"></xref>)</t>

            <t>Option-length: Length of the enclosed data in octets.</t>

            <t>Encr DNS Types (Encrypted DNS Types): Indicates the type(s) of
            the encrypted DNS server conveyed in this attribute. The format of
            this 8-bit field is shown in <xref target="types"></xref>. <figure
                align="center" anchor="types" title="Encrypted DNS Types">
                <artwork align="center"><![CDATA[+-+-+-+-+-+-+-+-+
|U|U|U|U|U|Q|H|T|
+-+-+-+-+-+-+-+-+  ]]></artwork>
              </figure><list style="empty">
                <t>T: If set, this bit indicates that the server supports DoT
                <xref target="RFC7858"></xref>.</t>

                <t>H: If set, this bit indicates that the server supports DoH
                <xref target="RFC8484"></xref>.</t>

                <t>Q: If set, this bit indicates that the server supports DoQ
                <xref target="I-D.ietf-dprive-dnsoquic"></xref>.</t>

                <t>U: Unassigned bits. These bits MUST be unset by the sender.
                Associating a meaning with an unassigned bit can be done via
                Standards Action <xref target="RFC8126"></xref>.</t>
              </list>In a request, these bits are assigned to indicate the
            requested encrypted DNS server type(s) by the client. In a
            response, these bits are set as a function of the encrypted DNS
            supported by the server and the requested encrypted DNS server
            type(s).<vspace blankLines="1" />To keep the packet small, if more
            than one encrypted DNS type (e.g., both DoH and DoT) are to be
            returned to a requesting client and the same ADN is used for these
            types, the corresponding bits MUST be set in the 'Encrypted DNS
            Types' field of the same option instance in a response. For
            example, if the client requested DoH and DoT and the server
            supports both with the same ADN, then both T and H bits must be
            set.</t>

            <t>Authentication Domain Name: A fully qualified domain name of
            the encrypted DNS server. This field is formatted as specified in
            Section 10 of <xref target="RFC8415"></xref>.</t>
          </list></t>

        <t><?rfc subcompact="no" ?>An example of the Authentication Domain
        Name encoding is shown in <xref target="fqdn"></xref>. This example
        conveys the FQDN "doh1.example.com.".</t>

        <t><figure anchor="fqdn"
            title="An example of the authentication-domain-name Encoding">
            <artwork><![CDATA[      +------+------+------+------+------+------+------+------+------+
      | 0x04 |   d  |   o  |   h  |  1   | 0x07 |   e  |   x  |   a  |
      +------+------+------+------+------+------+------+------+------+
      |   m  |   p  |   l  |   e  | 0x03 |   c  |   o  |   m  | 0x00 |
      +------+------+------+------+------+------+------+------+------+
]]></artwork>
          </figure></t>

        <t>The DHCPv6 Encrypted DNS Address option is used to configure a list
        of IP addresses and a port number of the encrypted DNS server. The
        format of this option is shown in <xref
        target="dhcpv6_add"></xref>.</t>

        <t><figure anchor="dhcpv6_add"
            title="DHCPv6 Encrypted DNS Address Option">
            <artwork><![CDATA[    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |    OPTION_V6_ENC_ADD          |         Option-length         |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |  Enc DNS Type |   Unassigned  |          Port Number          |
   +---------------+---------------+-------------------------------+
   |                                                               | 
   ~                         IPv6 Addresses                        ~
   |                                                               |
   +---------------------------------------------------------------+
]]></artwork>
          </figure>The fields of the option shown in <xref
        target="dhcpv6_add"></xref> are as follows:</t>

        <t><list style="symbols">
            <t>Option-code: OPTION_V6_ENC_ADD (TBA2, see <xref
            target="iana6"></xref>)</t>

            <t>Option-length: Length of the enclosed data in octets.</t>

            <t>Encr DNS Types (Encrypted DNS Types): Indicates the type(s) of
            the encrypted DNS server conveyed in this attribute. The format of
            this 8-bit field is shown in <xref target="types"></xref>. In a
            request, these bits are set to indicate the requested encrypted
            DNS server type(s) by the client. In a response, these bits are
            set as a function of the encrypted DNS supported by the server and
            the requested encrypted DNS server type(s).</t>

            <t>Unassigned: These bits MUST be unset by the sender. Associating
            a meaning with an unassigned bit can be done via Standards Action
            <xref target="RFC8126"></xref>.</t>

            <t>Port Number: If not null, Indicates the port number to be used
            for the encrypted DNS. If this field is to zero, this indicates
            that default port numbers should be used. As a reminder, the
            default port number is 853 for DoT and 443 for DoH.</t>

            <t>IPv6 Addresses: Indicates one or more IPv6 addresses to reach
            the encrypted DNS server.</t>
          </list></t>

        <t>Multiple instances of OPTION_V6_ENC_ADN (or OPTION_V6_ENC_ADD) may
        be returned to a DHCPv6 client; each pointing to a distinct encrypted
        DNS server type.</t>

        <t>To discover an encrypted DNS server, the DHCPv6 client includes
        OPTION_V6_ENC_ADN and OPTION_V6_ENC_ADD in an Option Request Option
        (ORO), as in Sections 18.2.1, 18.2.2, 18.2.4, 18.2.5, 18.2.6, and 21.7
        of <xref target="RFC8415"></xref>. The DHCPv6 client sets the
        Encrypted DNS Types field to the requested encrypted DNS server
        type(s).</t>

        <t>If the DHCPv6 client requested more than one encrypted DNS server
        type, the DHCP client MUST be prepared to receive multiple
        OPTION_V6_ENC_ADN (or OPTION_V6_ENC_ADD) options; each option is to be
        treated as a separate encrypted DNS server. </t>

        <t>If more than one encrypted DNS server types is supported on the
        same IP address and default port numbers are used, one instance of
        OPTION_V6_ENC_ADD option with the appropriate bits set in "Encr DNS
        Types" field should be returned by the DHCP server. </t>
      </section>

      <section anchor="DHCP" title="DHCP Encrypted DNS Option">
        <t>The DHCP Encrypted DNS option is used to configure an
        authentication domain name of the encrypted DNS server. The format of
        this option is illustrated in <xref target="dhcpri_dns"></xref>.</t>

        <t><figure anchor="dhcpri_dns" title="DHCP Encrypted DNS Option">
            <artwork><![CDATA[          0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         |     TBA3      |     Length    |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         | Encr DNS Types| Num Addresses |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         |           Port Number         |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         |                               |
         ~         IPv4 Address(es)      ~
         |                               |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
         |                               |
         ~  Authentication Domain Name   ~
         |                               |
         +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+  

with:

   The format of IPv4 Address(es) field is as follows:

         0     8     16    24    32    40    
         +-----+-----+-----+-----+-----+---
         |  a1 |  a2 |  a3 |  a4 |  a1 |  ...
         +-----+-----+-----+-----+-----+---
          IPv4 Address 1          IPv4 Address 2

   This format assumes that an IPv4 address is encoded as a1.a2.a3.a4.

   The format of the Authentication Domain Name field is as follows:

          Authentication Domain Name 
         +-----+-----+-----+-----+-----+--
         |  s1 |  s2 |  s3 |  s4 | s5  |  ...
         +-----+-----+-----+-----+-----+--

   The values s1, s2, s3, etc. represent the domain name labels in the
   domain name encoding.

]]></artwork>
          </figure></t>

        <t>The fields of the option shown in <xref target="dhcpri_dns"></xref>
        are as follows:<?rfc subcompact="yes" ?><list style="symbols">
            <t>Code: OPTION_V4_ENC_DNS (TBA3, see <xref
            target="iana4"></xref>).</t>

            <t>Length: Length of the enclosed data in octets.</t>

            <t>Encr DNS Types (Encrypted DNS Types): Indicates the type(s) of
            the encrypted DNS server conveyed in this attribute. The format of
            this field is shown in <xref target="types"></xref>.</t>

            <t>Num Addresses: Number of included IPv4 addresses.</t>

            <t>Port Number: If set, it indicates the port number to be used
            for the encrypted DNS. A null value indicates that defaults port
            numbers are used. As a reminder, the default port number is 853
            for DoT and 443 for DoH.</t>

            <t>IPv4 Addresses: Indicates one or more IPv4 addresses to reach
            the encrypted DNS server.</t>

            <t>Authentication Domain Name: The domain name of the DoH/DoT
            server. This field is formatted as specified in Section 10 of
            <xref target="RFC8415"></xref>.</t>
          </list></t>

        <t><?rfc subcompact="no" ?>OPTION_V4_ENC_DNS is a
        concatenation-requiring option. As such, the mechanism specified in
        <xref target="RFC3396"></xref> MUST be used if OPTION_V4_ENC_DNS
        exceeds the maximum DHCP option size of 255 octets.</t>

        <t>To discover an encrypted DNS server, the DHCP client requests the
        Encrypted DNS server by including OPTION_V4_ENC_DNS in a Parameter
        Request List option <xref target="RFC2132"></xref>. The DHCP client
        sets the Encrypted DNS Types field to the requested encrypted DNS
        server.</t>

        <t>If the DHCP client requested more than one encrypted DNS server
        type, the DHCP client MUST be prepared to receive multiple DHCP
        OPTION_V4_ENC_DNS options; each option is to be treated as a separate
        encrypted DNS server.</t>
      </section>

      <section anchor="RA" title="RA Encrypted DNS Option">
        <t>The IPv6 Router Advertisement (RA) Encrypted DNS ADN option is used
        to configure an authentication domain name of the encrypted DNS
        server. The format of this option is illustrated in <xref
        target="ra_dns"></xref>.</t>

        <t><figure anchor="ra_dns" title="RA Encrypted DNS ADN Option">
            <artwork><![CDATA[      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |     TBA3      |     Length    | Encr DNS Types|   Unassigned  |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                           Lifetime                            |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                                                               |
     :                   Authentication Domain Name                  :
     |                                                               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

]]></artwork>
          </figure></t>

        <t>The fields of the option shown in <xref target="ra_dns"></xref> are
        as follows:<?rfc subcompact="yes" ?><list style="symbols">
            <t>Type: 8-bit identifier of the Encrypted DNS Option as assigned
            by IANA (TBA3, see <xref target="iana7"></xref>).</t>

            <t>Length: 8-bit unsigned integer. The length of the option
            (including the Type and Length fields) is in units of 8
            octets.</t>

            <t>Encr DNS Types (Encrypted DNS Types): Indicates the type(s) of
            the encrypted DNS server conveyed in this attribute. The format of
            this field is shown in <xref target="types"></xref>.</t>

            <t>Unassigned: This field is unused. It MUST be initialized to
            zero by the sender and MUST be ignored by the receiver.</t>

            <t>Lifetime: 32-bit unsigned integer. The maximum time in seconds
            (relative to the time the packet is received) over which the
            discovered encrypted DNS servers are valid. <vspace
            blankLines="1" />The value of Lifetime SHOULD by default be at
            least 3 * MaxRtrAdvInterval, where MaxRtrAdvInterval is the
            maximum RA interval as defined in <xref target="RFC4861"></xref>.
            <vspace blankLines="1" />A value of all one bits (0xffffffff)
            represents infinity. <vspace blankLines="1" />A value of zero
            means that this encrypted DNS server MUST no longer be used.</t>

            <t>Authentication Domain Name: The domain name of the encrypted
            DNS server. This field is formatted as specified in Section 10 of
            <xref target="RFC8415"></xref>.<vspace blankLines="1" />This field
            MUST be padded with zeros so that its size is a multiple of 8
            octets.</t>
          </list></t>

        <t><?rfc subcompact="no" ?>The IPv6 Router Advertisement (RA)
        Encrypted DNS Address option is used to configure a port number and a
        list of IPv6 addresses of the encrypted DNS server. The format of this
        option is illustrated in <xref target="ra_add"></xref>.</t>

        <t><figure anchor="ra_add" title="RA Encrypted DNS Address Option">
            <artwork><![CDATA[      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |     TBA5      |     Length    |           Port Number         |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     | Encr DNS Types|                    Unassigned                 |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                           Lifetime                            |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
     |                                                               |
     :                         IPv6 Address(es)                      :
     |                                                               |
     +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

]]></artwork>
          </figure>The fields of the option shown in <xref
        target="ra_add"></xref> are as follows:</t>

        <t><list style="symbols">
            <t>Type: 8-bit identifier of the Encrypted DNS Address Option as
            assigned by IANA (TBA5, see <xref target="iana7"></xref>).</t>

            <t>Length: 8-bit unsigned integer. The length of the option
            (including the Type and Length fields) is in units of 8
            octets.</t>

            <t>Port Number: If not null, it iIndicates the port number to be
            used for the encrypted DNS. A null value indicates that default
            port numbers must be used. As a reminder, the default port number
            is 853 for DoT and 443 for DoH.</t>

            <t>Encr DNS Types (Encrypted DNS Types): Indicates the type(s) of
            the encrypted DNS server conveyed in this attribute. The format of
            this field is shown in <xref target="types"></xref>.</t>

            <t>Unassigned: This field is unused. It MUST be initialized to
            zero by the sender and MUST be ignored by the receiver.</t>

            <t>Lifetime: 32-bit unsigned integer. The maximum time in seconds
            (relative to the time the packet is received) over which the
            discovered encrypted DNS servers are valid. <vspace
            blankLines="1" />The value of Lifetime SHOULD by default be at
            least 3 * MaxRtrAdvInterval, where MaxRtrAdvInterval is the
            maximum RA interval as defined in <xref target="RFC4861"></xref>.
            <vspace blankLines="1" />A value of all one bits (0xffffffff)
            represents infinity. <vspace blankLines="1" />A value of zero
            means that this encrypted DNS server MUST no longer be used.</t>

            <t>IPv6 Address(es) : One or more IPv6 addresses of the encrypted
            DNS server. Link-local addresses MAY be used. </t>
          </list></t>
      </section>
    </section>

    <section anchor="URI" title="DoH URI Templates">
      <t>DoH servers may support more than one URI Template <xref
      target="RFC8484"></xref>. Also, if the resolver hosts several DoH
      services (e.g., no-filtering, blocking adult content, blocking malware),
      these services can be discovered as templates. The following discusses a
      mechanism for a DoH client to retrieve the list of supported templates
      by a DoH server.</t>

      <t>Upon discovery of a DoH resolver (<xref target="RI"></xref>), the DoH
      client may contact that DoH resolver to retrieve the list of supported
      DoH services using the well-known URI defined in. DoH clients
      re-iterates that request regularly to retrieve an updated list of
      supported DoH services. Note that a "push" mode can be considered using
      the mechanism defined in <xref target="I-D.ietf-dnssd-push"></xref>.</t>

      <t>Alternatively, dedicated DHCP/RA options may be defined to convey an
      URI template.</t>

      <t><list style="empty">
          <t>Note: More feedback form the WG is needed to decide which
          approach to follow. </t>
        </list>How a DoH client makes use of the configured DoH services is
      out of scope of this document.</t>
    </section>

    <section title="Make Use of Discovered Encrypted DNS Server">
      <t>Even if the use of a discovered encrypted DNS server is beyond the
      discovery process and falls under encrypted server selection, the
      following subsections discuss conditions under which discovered
      encrypted DNS server can be used.</t>

      <t><list style="symbols">
          <t>Note: Validation has to be discussed in the WG to address the
          requirement of associated/equivalent resolver (see
          https://tools.ietf.org/html/draft-box-add-requirements-00#section-3).
          </t>
        </list></t>

      <section anchor="auto" title="Encrypted DNS Auto-Upgrade">
        <t>Additional considerations are discussed below for the use of DoH
        and DoT servers provided by local networks:<list style="symbols">
            <t>If the DNS server's IP address discovered by using DHCP/RA is
            pre-configured in the OS or Browser as a verified resolver (e.g.,
            part of an auto-upgrade program such as <xref
            target="Auto-upgrade"></xref>), the DNS client auto-upgrades to
            use the pre-configured encrypted DNS server tied to the discovered
            DNS server IP address. In such a case the DNS client will perform
            additional checks out of band, such as confirming that the Do53 IP
            address and the encrypted DNS server are owned and operated by the
            same organisation.</t>

            <t>Similarly, if the ADN conveyed in DHCP/RA (<xref
            target="RI"></xref>) is pre-configured in the OS or browser as a
            verified resolver, the DNS client auto-upgrades to establish an
            encrypted a DoH/DoT/DoQ session with the ADN.<vspace
            blankLines="1" />In such case, the DNS client matches the domain
            name in the Encrypted DNS DHCP/RA option with the 'DNS-ID'
            identifier type within subjectAltName entry in the server
            certificate conveyed in the TLS handshake.</t>
          </list></t>
      </section>

      <section anchor="identity" title="DNS Server Identity Assertion">
        <t>If the discovered encrypted DNS server information is not
        pre-configured in the OS or the browser, the DNS client needs evidence
        about the encrypted server to assess its trustworthiness and a way to
        appraise such evidence. The DNS client can validate the Policy
        Assertion Token signature to cryptographically assert the DNS server
        identity to identify it is connecting to an encrypted DNS server
        hosted by a legal organization and the user can identify the encrypted
        DNS server hosted by a specific organization (e.g., ISP).</t>
      </section>

      <section anchor="ad" title="Other Deployment Options">
        <t>Some deployment options to securely configure hosts are discussed
        below. These options are provided for the sake of completeness.</t>

        <t><list style="symbols">
            <t>If Device Provisioning Protocol (DPP) <xref
            target="DPP"></xref> is used, the configurator can securely
            configure devices in the home network with the local DoT/DoH
            server using DPP. If the DoT/DoH servers use raw public keys <xref
            target="RFC7250"></xref>, the Subject Public Key Info (SPKI) pin
            set <xref target="RFC7250"></xref> of raw public keys may be
            encoded in a QR code. The configurator (e.g., mobile device) can
            scan the QR code and provision SPKI pin set in OS/Browser. The
            configurator can in-turn securely configure devices (e.g.,
            thermostat) in the home network with the SPKI pin set using
            DPP.</t>

            <t>If a CPE is co-located with security services within the home
            network, the CPE can use WPA-PSK but with unique pre-shared keys
            for different endpoints to deal with security issues. In such
            networks, <xref target="I-D.reddy-add-iot-byod-bootstrap"></xref>
            may be used to securely bootstrap endpoint devices with the
            authentication domain name and DNS server certificate of the local
            network's DoH/DoT server. <vspace blankLines="1" />The OS would
            not know if the WPA pre-shared-key is the same for all clients or
            a unique pre-shared key is assigned to the host. Hence, the user
            has to indicate to the system that a unique pre-shared key is
            assigned to trigger the bootstrapping procedure. <vspace
            blankLines="1" />If the device joins a home network using a single
            shared password among all the attached devices, a compromised
            device can host a fake access point, and the device cannot be
            securely bootstrapped with the home network's DoH/DoT server.</t>
          </list></t>
      </section>
    </section>

    <section anchor="forwarder"
             title="Hosting Encrypted DNS Forwarder in the CPE">
      <section anchor="forwarder_m" title="Managed CPEs">
        <t>The following mechanisms can be used to host a DoH/DoT forwarder in
        a managed CPE (<xref target="mcpe"></xref>).</t>

        <section anchor="acme" title="ACME">
          <t>The ISP can assign a unique FQDN (e.g., cpe1.example.com) and a
          domain-validated public certificate to the encrypted DNS forwarder
          hosted on the CPE. Automatic Certificate Management Environment
          (ACME) <xref target="RFC8555"></xref> can be used by the ISP to
          automate certificate management functions such as domain validation
          procedure, certificate issuance and certificate revocation.</t>

          <t>The managed CPE should support a configuration parameter to
          instruct the CPE whether it has to relay the encrypted DNS server
          received from the ISP's network or has to announce itself as a
          forwarder within the local network. The default behavior of the CPE
          is to supply the encrypted DNS server received from the ISP's
          network.</t>
        </section>

        <section title="Auto-Upgrade Based on Domains and their Subdomains">
          <t>If the ADN conveyed in DHCP/RA (<xref target="RI"></xref>) is
          pre-configured in popular OSes or browsers as a verified resolver
          and the auto-upgrade (<xref target="auto"></xref>) is allowed for
          both the pre-configured ADN and its sub-domains, the DoH/DoT client
          will learn the local encrypted DNS forwarder using DHCP/RA and
          auto-upgrade because the left-most label of the pre-configured ADN
          would match the subjectAltName value in the server certificate.
          Concretely, the CPE can communicate the ADN of the local DoH
          forwarder (<xref target="acme"></xref>) to internal hosts using
          DHCP/RA (<xref target="RI"></xref>).</t>

          <t>Let's suppose that "example.net" is pre-configured as a verified
          resolved in the browser or OS. If the DoH/DoT client discovers a
          local forwarder "cpe1-internal.example.net", the encrypted DNS
          client will auto-upgrade because the pre-configured ADN would match
          subjectAltName value "cpe1-internal.example.net" of type dNSName. As
          shown in <xref target="subdomainex"></xref>, the auto-upgrade to a
          rogue server advertising "rs.example.org" will fail. <figure
              align="center" anchor="subdomainex"
              title="A Simplified Example of Auto-upgrade based on Sub-domains">
              <artwork><![CDATA[
                         Rogue Server
             |              | 
             X<==DHCP=======|  
             | {ADN=        |        
             |  rs.example.org, @rs} 
             |              |                  --,--,-
             |        ,+-,--+--.             ,/  ISP   \.
             |     ,-'          `-.       ,-'            `-.
         DoH/DoT --(      LAN      CPE----( S (@1)          )
    capable client  `-.          ,-'|      `-.           ,-'
             |        `--'--'--'    |         `--'--'--'
             |<========DHCP========>|        
             |{ADN=                 |        
             |  cpe1-internal.example.net, @i}    
             |        
             |<========DoH=========>|    
             |                      |     
Legend:
  * S: DoH/DoT server
  * @1: IP address of S
  * @i: internal IP address of the CPE
  * @rs: IP address of a rogue server
]]></artwork>
            </figure></t>
        </section>
      </section>

      <section anchor="forwarder_u" title="Unmanaged CPEs">
        <t>The approach specified in <xref target="forwarder_m"></xref> does
        not apply for hosting a DNS forwarder in an unmanaged CPE.</t>

        <t>The unmanaged CPE administrator (referred to as administrator) can
        host a DoH/DoT forwarder on the unmanaged CPE. This assumes the
        following:<list style="symbols">
            <t>The encrypted DNS server certificate is managed by the entity
            in-charge of hosting the encrypted DNS forwarder. <vspace
            blankLines="1" />Alternatively, a security service provider can
            assign a unique FQDN to the CPE. The encrypted DNS forwarder will
            act like a private encrypted DNS server only be accessible from
            within the home network.</t>

            <t>The encrypted DNS forwarder will either be configured to use
            the ISP's or a 3rd party encrypted DNS server.</t>

            <t>The unmanaged CPE will advertise the encrypted DNS forwarder
            ADN using DHCP/RA to internal hosts.</t>
          </list></t>

        <t><xref target="internal_forwarded"></xref> illustrates an example of
        an unmanaged CPE hosting a forwarder which connects to a 3rd party
        encrypted DNS server. In this example, the DNS information received
        from the managed CPE (and therefore from the ISP) is ignored by the
        Internal CPE hosting the forwarder.</t>

        <t><figure align="center" anchor="internal_forwarded"
            title="Example of an Internal CPE Hosting a Forwarder">
            <artwork align="center"><![CDATA[         ,--,--,--.                         ,--,
       ,'         Internal   Managed     ,-'    '-     3rd Party
Host--(  Network#A  CPE--------CPE------(   ISP   )--- DNS Server
 |     `.         ,-'|          |        `-.    -'       |
 |       `-'--'--'   |          |<==DHCP==>|`--'         |
 |                   |<==DHCP==>|          |             | 
 |<======DHCP=======>|          |                        |
 |     {RI, @i}      |                                   |
 |<==Encrypted DNS==>|<==========Encrypted DNS==========>|

Legend:
  * @i: IP address of the DNS forwarder hosted in the Internal
        CPE. 
]]></artwork>
          </figure></t>
      </section>
    </section>

    <section title="Legacy CPEs">
      <t>Hosts serviced by legacy CPEs that can't be upgraded to support the
      options defined in <xref target="RI"></xref> won't be able to learn the
      encrypted DNS server hosted by the ISP, in particular. If the ADN is not
      discovered using DHCP/RA, such hosts will have to fallback to use the
      special-use domain name defined in <xref
      target="I-D.pp-add-resinfo"></xref> to discover the encrypted DNS server
      and to retrieve the list of supported DoH services using the RESINFO
      RRtype <xref target="I-D.pp-add-resinfo"></xref>.</t>

      <t>The DHCP/RA option to discover ADN takes precedence over special-use
      domain name since the special-use domain name is suseptible to both
      internal and external attacks whereas DHCP/RA is only vulnerable to
      internal attacks.</t>
    </section>

    <section anchor="Security" title="Security Considerations">
      <section title="Spoofing Attacks">
        <t>Because DHCP/RA messages are not encrypted or protected against
        modification in any way, their content can be spoofed or modified by
        active attackers (e.g., compromised devices within the home network).
        An active attacker (Section 3.3 of <xref target="RFC3552"></xref>) can
        spoof the DHCP/RA response to provide the attacker's DoH/DoT/DoQ
        server. Note that such an attacker can launch other attacks as
        discussed in Section 22 of <xref target="RFC8415"></xref>. The
        attacker can get a domain name, domain-validated public certificate
        from a CA, host a DoH/DoT/DoQ server and claim the best DNS privacy
        preservation policy. Also, an attacker can use a public IP address,
        get an 'IP address'-validated public certificate from a CA, host a
        DoH/DoT/DoQ server and claim the best DNS privacy preservation
        policy.</t>

        <t>The possible mitigations for this attack are listed below:</t>

        <t><list style="symbols">
            <t>Encrypted DNS server pre-configured in the OS or browser. If
            the local DoH/DoT server offers malware and phishing filtering
            service, an attacker can spoof the DHCP/RA response to provide an
            non-filtering DNS server pre-configured in the OS or browser,
            which the attacker can leverage to deliver malware or mislead the
            user to access phishing sites. If the discovered encrypted DNS
            server does not meet the filtering requirements of the user, the
            DNS client can take appropriate actions. </t>

            <t>Cryptographically assert the DNS server identity for the DNS
            client to identify it is connecting to an is encrypted DNS server
            hosted by an legal organization and for the user to identify the
            encrypted DNS server hosted by a specific organization.</t>
          </list></t>

        <t>DoT/DoH sessions with rogue servers spoofing the IP address of a
        DNS server will fail because the DNS client will fail to authenticate
        that rogue server based upon PKIX authentication <xref
        target="RFC6125"></xref> based upon the authentication domain name in
        the Reference Identifier Option. DNS clients that ignore
        authentication failures and accept spoofed certificates will be
        subject to attacks (e.g., redirect to malicious servers, intercept
        sensitive data).</t>
      </section>

      <section title="Deletion Attacks">
        <t>If the DHCP responses or RAs are dropped by the attacker, the
        client can fallback to use a pre-configured encrypted DNS server.
        However, the use of policies to select servers is out of scope of this
        document.</t>

        <t>Note that deletion attack is not specific to DHCP/RA.</t>
      </section>

      <section title="Passive Attacks">
        <t>A passive attacker (Section 3.2 of <xref target="RFC3552"></xref>)
        can identify a host is using DHCP/RA to discover an encrypted DNS
        server and can infer that host is capable of using DoH/DoT/DoQ to
        encrypt DNS messages. However, a passive attacker cannot spoof or
        modify DHCP/RA messages.</t>
      </section>

      <section title="Security Capabilities of CPEs">
        <t>TCP connections received from outside the home network MUST be
        discarded by the encrypted DNS forwarder in the CPE. This behavior
        adheres to REQ#8 in <xref target="RFC6092"></xref>; it MUST apply for
        both IPv4 and IPv6.</t>

        <t>Various home routers also offer levels of security. Attacks of
        spoofed or modified DHCP responses and RA messages by attackers within
        the home network may be mitigated by making use of the following
        mechanisms:</t>

        <t><list style="symbols">
            <t>DHCPv6-Shield described in <xref target="RFC7610"></xref>, the
            CPEs discards DHCP response messages received from any local
            endpoint.</t>

            <t>RA-Guard described in <xref target="RFC7113"></xref>, the CPE
            discards RAs messages received from any local endpoint.</t>

            <t>Source Address Validation Improvement (SAVI) solution for DHCP
            described in <xref target="RFC7513"></xref>, the CPE filters
            packets with forged source IP addresses.</t>
          </list></t>
      </section>

      <section title="Wireless Security - Authentication Attacks">
        <t>Wireless LAN (WLAN) as frequently deployed in home networks is
        vulnerable to various attacks (e.g., <xref target="Evil-Twin"></xref>,
        <xref target="Krack"></xref>, <xref target="Dragonblood"></xref>).
        Because of these attacks, only cryptographically authenticated
        communications are trusted on WLANs. This means information provided
        by such networks via DHCP, DHCPv6, or RA (e.g., NTP server, DNS
        server, default domain) are untrusted because DHCP and RA are not
        authenticated.</t>

        <t>With the current deployments (2020), the pre-shared-key is the same
        for all clients that connect to the same WLAN. This results in the key
        being shared to attackers resulting in security breach.
        Man-in-the-middle attacks are possible within home networks because
        WLAN authentication lacks peer entity authentication.</t>

        <t>This leads to the need for provisioning unique credentials for
        different clients. Endpoints can be provisioned with unique
        credentials (username and password, typically) provided by the home
        network administraor to mutually authenticate to the home WLAN Access
        Point (e.g., 802.1x Wireless User Authentication on OpenWRT <xref
        target="dot1x"></xref>, EAP-pwd <xref target="RFC8146"></xref>). Not
        all of endpoint devices (e.g., IoT devices) support 802.1x supplicant
        and need an alternate mechanism to connect to the home network. To
        address this limitation, unique pre-shared keys can be created for
        each such device and WPA-PSK is used (e.g., <xref
        target="PSK"></xref>).</t>
      </section>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t></t>

      <section anchor="iana6" title="DHCPv6 Options">
        <t>IANA is requested to assign the following new DHCPv6 Option Code in
        the registry maintained in <xref target="DHCPV6"></xref>.</t>

        <texttable>
          <ttcol>Value</ttcol>

          <ttcol>Description</ttcol>

          <ttcol>Client ORO</ttcol>

          <ttcol>Singleton Option</ttcol>

          <ttcol>Reference</ttcol>

          <c>TBA1</c>

          <c>OPTION_V6_ENC_ADN</c>

          <c>Yes</c>

          <c>No</c>

          <c>[ThisDocument]</c>

          <c>TBA2</c>

          <c>OPTION_V6_ENC_ADD</c>

          <c>Yes</c>

          <c>No</c>

          <c>[ThisDocument]</c>
        </texttable>

        <t></t>
      </section>

      <section anchor="iana4" title="DHCP Option">
        <t>IANA is requested to assign the following new DHCP Option Code in
        the registry maintained in <xref target="BOOTP"></xref>.</t>

        <figure>
          <artwork><![CDATA[+------+------------------+-------+----------------+----------------+
| Tag  | Name             | Data  | Meaning        | Reference      |
|      |                  | Length|                |                |
+------+------------------+-------+----------------+----------------+
| TBA3 | OPTION_V4_ENC_DNS| N     | Encrypted DNS  | [ThisDocument] |
|      |                  |       | Server         |                |
+------+------------------+-------+----------------+----------------+]]></artwork>
        </figure>
      </section>

      <section anchor="iana7" title="RA Options">
        <t>IANA is requested to assign the following new IPv6 Neighbor
        Discovery Option type in the "IPv6 Neighbor Discovery Option Formats"
        sub-registry under the "Internet Control Message Protocol version 6
        (ICMPv6) Parameters" registry maintained in <xref
        target="ND"></xref>.</t>

        <texttable>
          <ttcol>Type</ttcol>

          <ttcol>Description</ttcol>

          <ttcol>Reference</ttcol>

          <c>TBA4</c>

          <c>DNS Encrypted DNS ADN Option</c>

          <c>[ThisDocument]</c>

          <c>TBA5</c>

          <c>DNS Encrypted DNS Address Option</c>

          <c>[ThisDocument]</c>
        </texttable>
      </section>
    </section>

    <section title="Acknowledgements">
      <t>Many thanks to Christian Jacquenet for the review.</t>

      <t>Thanks to Tommy Jensen, Stephen Farrell, Martin Thomson, Vittorio
      Bertola, Stephane Bortzmeyer, Ben Schwartz, and Iain Sharp for the
      comments.</t>

      <t>Thanks to Mark Nottingham for the feedback on HTTP redirection.</t>
    </section>
  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title="Normative References">
      <?rfc include='reference.RFC.2119'?>

      <?rfc include='reference.RFC.8174'?>

      <?rfc include='reference.RFC.8310'?>

      <?rfc include='reference.RFC.4861'?>

      <?rfc include='reference.RFC.8415'?>

      <?rfc include='reference.RFC.2132'?>

      <?rfc include='reference.RFC.8106'?>

      <?rfc include='reference.RFC.8126'?>

      <?rfc include='reference.RFC.3396'?>
    </references>

    <references title="Informative References">
      <?rfc include='reference.RFC.6092'?>

      <?rfc include='reference.RFC.8499'?>

      <?rfc include='reference.RFC.6125'?>

      <?rfc include='reference.RFC.3646'?>

      <?rfc include='reference.RFC.8520'?>

      <?rfc include='reference.RFC.8555'?>

      <?rfc include='reference.RFC.7250'?>

      <?rfc include='reference.RFC.7610'?>

      <?rfc include='reference.RFC.7113'?>

      <?rfc include='reference.RFC.7858'?>

      <?rfc include='reference.RFC.8484'?>

      <?rfc include='reference.I-D.ietf-dprive-dnsoquic'?>

      <?rfc include='reference.I-D.reddy-add-iot-byod-bootstrap'?>

      <?rfc include='reference.I-D.ietf-v6ops-rfc7084-bis' ?>

      <?rfc include='reference.I-D.ietf-dnsop-terminology-ter'?>

      <?rfc include='reference.I-D.pp-add-resinfo'?>

      <?rfc include='reference.I-D.ietf-dnssd-push'?>

      <?rfc include='reference.RFC.6731'?>

      <?rfc include='reference.RFC.3552'?>

      <?rfc include='reference.RFC.7513'?>

      <?rfc include='reference.RFC.7969'?>

      <?rfc include='reference.RFC.8489'?>

      <?rfc include='reference.RFC.8146'?>

      <?rfc include='reference.RFC.8305'?>

      <reference anchor="TR-069"
                 target="https://www.broadband-forum.org/technical/download/TR-069.pdf">
        <front>
          <title>CPE WAN Management Protocol</title>

          <author fullname="The Broadband Forum" initials=""
                  surname="The Broadband Forum">
            <organization></organization>
          </author>

          <date month="December" year="2018" />
        </front>
      </reference>

      <reference anchor="DPP"
                 target="https://www.wi-fi.org/file/device-provisioning-protocol-specification">
        <front>
          <title>Device Provisioning Protocol Specification</title>

          <author fullname="The Wi-Fi Alliance" initials=""
                  surname="The Wi-Fi Alliance">
            <organization></organization>
          </author>

          <date />
        </front>
      </reference>

      <reference anchor="TS.24008"
                 target="http://www.3gpp.org/DynaReport/24008.htm">
        <front>
          <title>Mobile radio interface Layer 3 specification; Core network
          protocols; Stage 3 (Release 16)</title>

          <author fullname="" surname="">
            <organization>3GPP</organization>
          </author>

          <date day="0" month="December" year="2019" />
        </front>
      </reference>

      <reference anchor="Auto-upgrade"
                 target="docs.google.com/document/d/128i2YTV2C7T6Gr3I-81zlQ-_Lprnsp24qzy_20Z1Psw/edit">
        <front>
          <title>DoH providers: criteria, process for Chrome</title>

          <author>
            <organization>The Unicode Consortium</organization>
          </author>

          <date day="" month="" year="" />
        </front>
      </reference>

      <reference anchor="Evil-Twin"
                 target="https://en.wikipedia.org/wiki/Evil_twin_(wireless_networks)">
        <front>
          <title>Evil twin (wireless networks)</title>

          <author>
            <organization>The Unicode Consortium</organization>
          </author>

          <date day="" month="" year="" />
        </front>
      </reference>

      <reference anchor="Krack" target="https://www.krackattacks.com/">
        <front>
          <title>Key Reinstallation Attacks</title>

          <author>
            <organization>The Unicode Consortium</organization>
          </author>

          <date day="" month="" year="2017" />
        </front>
      </reference>

      <reference anchor="Dragonblood"
                 target="https://papers.mathyvanhoef.com/dragonblood.pdf">
        <front>
          <title>Dragonblood: Analyzing the Dragonfly Handshake of WPA3 and
          EAP-pwd</title>

          <author>
            <organization>The Unicode Consortium</organization>
          </author>

          <date day="" month="" year="" />
        </front>
      </reference>

      <reference anchor="PSK"
                 target="https://www.cisco.com/c/en/us/td/docs/wireless/controller/technotes/8-5/b_Identity_PSK_Feature_Deployment_Guide.html">
        <front>
          <title>Identity PSK Feature Deployment Guide</title>

          <author>
            <organization>Cisco</organization>
          </author>

          <date day="" month="" year="" />
        </front>
      </reference>

      <reference anchor="dot1x"
                 target="https://openwrt.org/docs/guide-user/network/wifi/wireless.security.8021x">
        <front>
          <title>Basic 802.1x Wireless User Authentication</title>

          <author>
            <organization>Cisco</organization>
          </author>

          <date day="" month="" year="" />
        </front>
      </reference>

      <reference anchor="DHCPV6"
                 target="https://www.iana.org/assignments/dhcpv6-parameters/dhcpv6-parameters.xhtml#dhcpv6-parameters-2">
        <front>
          <title></title>

          <author>
            <organization></organization>
          </author>

          <date />
        </front>
      </reference>

      <reference anchor="ND"
                 target="http://www.iana.org/assignments/icmpv6-parameters/    icmpv6-parameters.xhtml#icmpv6-parameters-5">
        <front>
          <title></title>

          <author>
            <organization></organization>
          </author>

          <date />
        </front>
      </reference>

      <reference anchor="BOOTP"
                 target="https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml#options">
        <front>
          <title></title>

          <author>
            <organization></organization>
          </author>

          <date />
        </front>
      </reference>
    </references>
  </back>
</rfc>
